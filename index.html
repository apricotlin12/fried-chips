<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <script>
    fetch("head.html")
      .then(res => res.text())
      .then(html => {
        document.head.innerHTML += html;
      });
  </script>
</head>
<body>

<!-- header -->
<div id="header-placeholder"></div>

<!-- 主內容 -->
<main>
  <div class="now-event">
    <h4>相關連結：</h4>
    <div class="list-group">
      <a href="https://x.com/TOUKEN_STAFF" target="_blank" class="list-group-item list-group-item-action list-group-item-warning">刀剣乱舞ONLINE【運営】</a>
    </div>
  </div>
  </br>
  <p>距離（台灣時間 yy/dd () HH:MM）還有</p>
  <h2 id="timer"></h2>
  <div id="open-door-placeholder"></div>
  </br>
  <div class="link-container">
    <a href="https://docs.google.com/spreadsheets/d/19JBK5QpqIJ7r-_mHh8leXSDP6ZIHk1JYhGR2Vw0puZM/edit?usp=sharing" target="_blank" class="btn btn-outline-warning">拍門許願池</a>
  </div>
</main>

<!-- footer -->
<div id="footer-placeholder"></div>

<script src="js/import-html.js"></script>
<script src="js/countdown.js"></script>
<script>
  const TIMES = {
    ACTIVITY_END: "2026-02-12T12:00:00+08:00",
    OPEN_DOOR: "2026-02-12T16:00:00+08:00"
  };
  const currentTime = Date.now();

  // 將 ISO 時間格式化成頁面上顯示的台灣時間標籤，例如：台灣時間 10/21 (二) 12:00
  function formatTaiwanLabel(iso) {
    const d = new Date(iso);
    const tz = 'Asia/Taipei';
    const parts = new Intl.DateTimeFormat('zh-Hant', {
      timeZone: tz,
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
      weekday: 'short'
    }).formatToParts(d).reduce((acc, p) => { acc[p.type] = p.value; return acc; }, {});
    // 將「星期二」或「週二」之類轉成單字（例：二）
    const weekdayMap = {
      '星期一': '一',
      '星期二': '二',
      '星期三': '三',
      '星期四': '四',
      '星期五': '五',
      '星期六': '六',
      '星期日': '日',
      '週一': '一',
      '週二': '二',
      '週三': '三',
      '週四': '四',
      '週五': '五',
      '週六': '六',
      '週日': '日'
    };
    const w = weekdayMap[parts.weekday] || (parts.weekday ? parts.weekday.replace(/星期|週/, '') : '');
    return `台灣時間 ${parts.month}/${parts.day} (${w}) ${parts.hour}:${parts.minute}`;
  }

  // 初始化 main p 的顯示（原本是硬編碼的時間）
  const pTag = document.querySelector('main p');
  if (pTag) pTag.textContent = `距離（${formatTaiwanLabel(TIMES.ACTIVITY_END)}）還有`;

  const activityEndTimestamp = new Date(TIMES.ACTIVITY_END).getTime();
  const openDoorTimestamp = new Date(TIMES.OPEN_DOOR).getTime();

  // 如果現在已經過了活動結束時間，就換倒數開門
  if (currentTime >= activityEndTimestamp) {
    startCountdown({
      targetTime: TIMES.OPEN_DOOR,
      elementId: "timer",
      endText: "開門啦！"
    });
  } else {
    startCountdown({
      targetTime: TIMES.ACTIVITY_END,
      elementId: "timer",
      endText: "關門啦！"
    });
  }

  const targetTime = activityEndTimestamp;
  const soundTime = openDoorTimestamp;
  let soundPlayed = false;

  /**
   * 根據距離目標時間，決定下次檢查的間隔
   * - 距離目標時間 > 30 分鐘：每 5 分鐘檢查一次
   * - 距離目標時間 > 2 分鐘且 <= 30 分鐘：每分鐘檢查一次
   * - 距離目標時間 <= 2 分鐘：每秒檢查一次
   * @param {number} targetTimestamp 目標時間的 timestamp
   * @returns {number} 毫秒間隔
   */
  function getCheckInterval(targetTimestamp) {
    const now = Date.now();
    const diff = targetTimestamp - now;
    if (diff > 30 * 60 * 1000) {
      return 5 * 60 * 1000; // 5分鐘
    } else if (diff > 2 * 60 * 1000) {
      return 60 * 1000; // 1分鐘
    } else {
      return 1000; // 1秒
    }
  }

  // 處理 open-the-door.html 的載入
  function handleOpenDoorHtml() {
    const now = Date.now();
    if (now >= targetTime && now < soundTime) {
      document.getElementById('open-door-placeholder').style.display = '';
      const audio = new Audio("sound/可是瑞凡_我回不去了.mp3");
      audio.play();
      fetch('open-the-door.html')
        .then(res => res.text())
        .then(data => {
          document.getElementById('open-door-placeholder').innerHTML = data;
          if (typeof initOpenDoor === 'function') initOpenDoor();
        });
    } else {
      setTimeout(handleOpenDoorHtml, getCheckInterval(targetTime));
    }
  }

  // 處理音效播放與隱藏
  function handleOpenDoorSound() {
    const now = Date.now();
    if (now >= soundTime && !soundPlayed) {
      soundPlayed = true;
      document.getElementById('open-door-placeholder').style.display = 'none';
      document.getElementById('timer').textContent = "開門啦！";
      const audio = new Audio("sound/全家便利商店_舊版.mp3");
      audio.play();
    } else if (!soundPlayed) {
      setTimeout(handleOpenDoorSound, getCheckInterval(soundTime));
    }
  }

  // 強制載入 open-the-door.html (備用)
  function forceLoadOpenDoorHtml() {
    const placeholder = document.getElementById('open-door-placeholder');
    placeholder.style.display = '';
    fetch('open-the-door.html')
      .then(res => res.text())
      .then(data => {
        placeholder.innerHTML = data;
        if (typeof initOpenDoor === 'function') initOpenDoor();
      });
  }

  // ACTIVITY_END_TIME 時間到了以後，修改活動倒數標籤內容
  function updateEndText() {
    const now = Date.now();
    if (now >= targetTime) {
      const pTag = document.querySelector('main p');
      if (pTag) pTag.textContent = `距離開門（${formatTaiwanLabel(TIMES.OPEN_DOOR)}）還有`;
    } else {
      setTimeout(updateEndText, getCheckInterval(targetTime));
    }
  }

  updateEndText();
  handleOpenDoorHtml();
  handleOpenDoorSound();
</script>
<script src="js/open-the-door.js"></script>
</body>
</html>
