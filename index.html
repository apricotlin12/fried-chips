<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <script>
    fetch("head.html")
      .then(res => res.text())
      .then(html => {
        document.head.innerHTML += html;
      });
  </script>
</head>
<body>

<!-- header -->
<div id="header-placeholder"></div>

<!-- 主內容 -->
<main>
  <div class="now-event">
    <h3>目前活動：</h3>
    <div class="list-group">
      <a href="https://x.com/TOUKEN_STAFF/status/1970762055230857729" target="_blank" class="list-group-item list-group-item-action list-group-item-warning">ドロップ率2倍</a>
    </div>
  </div>
  </br>
  <p>距離養肝周結束（台灣時間 9/30 (二) 12:00）還有</p>
  <h2 id="timer"></h2>
  <div id="open-door-placeholder"></div>
  </br>
  <div class="link-container">
    <a href="https://docs.google.com/spreadsheets/d/19JBK5QpqIJ7r-_mHh8leXSDP6ZIHk1JYhGR2Vw0puZM/edit?usp=sharing" target="_blank" class="btn btn-outline-warning">拍門許願池</a>
  </div>
</main>

<!-- footer -->
<div id="footer-placeholder"></div>

<script src="js/import-html.js"></script>
<script src="js/countdown.js"></script>
<script>
  const ACTIVITY_END_TIME = "2025-09-30T12:00:00+08:00";
  const OPEN_DOOR_TIME = "2025-09-30T15:00:00+08:00";

  startCountdown({
    targetTime: OPEN_DOOR_TIME,
    elementId: "timer",
    endText: "開門啦！"
  });

  const targetTime = new Date(ACTIVITY_END_TIME).getTime();
  const soundTime = new Date(OPEN_DOOR_TIME).getTime();
  let soundPlayed = false;

  /**
   * 根據距離目標時間，決定下次檢查的間隔
   * - 距離目標時間 > 30 分鐘：每 5 分鐘檢查一次
   * - 距離目標時間 > 2 分鐘且 <= 30 分鐘：每分鐘檢查一次
   * - 距離目標時間 <= 2 分鐘：每秒檢查一次
   * @param {number} targetTimestamp 目標時間的 timestamp
   * @returns {number} 毫秒間隔
   */
  function getCheckInterval(targetTimestamp) {
    const now = Date.now();
    const diff = targetTimestamp - now;
    if (diff > 30 * 60 * 1000) {
      return 5 * 60 * 1000; // 5分鐘
    } else if (diff > 2 * 60 * 1000) {
      return 60 * 1000; // 1分鐘
    } else {
      return 1000; // 1秒
    }
  }

  // 處理 open-the-door.html 的載入
  function handleOpenDoorHtml() {
    const now = Date.now();
    if (now >= targetTime && now < soundTime) {
      document.getElementById('open-door-placeholder').style.display = '';
      const audio = new Audio("sound/關門.mp3");
      audio.play();
      fetch('open-the-door.html')
        .then(res => res.text())
        .then(data => {
          document.getElementById('open-door-placeholder').innerHTML = data;
          if (typeof initOpenDoor === 'function') initOpenDoor();
        });
    } else {
      setTimeout(handleOpenDoorHtml, getCheckInterval(targetTime));
    }
  }

  // 處理音效播放與隱藏
  function handleOpenDoorSound() {
    const now = Date.now();
    if (now >= soundTime && !soundPlayed) {
      soundPlayed = true;
      document.getElementById('open-door-placeholder').style.display = 'none';
      document.getElementById('timer').textContent = "開門啦！";
      const audio = new Audio("sound/開門.mp3");
      audio.play();
    } else if (!soundPlayed) {
      setTimeout(handleOpenDoorSound, getCheckInterval(soundTime));
    }
  }

  // 強制載入 open-the-door.html (備用)
  function forceLoadOpenDoorHtml() {
    const placeholder = document.getElementById('open-door-placeholder');
    placeholder.style.display = '';
    fetch('open-the-door.html')
      .then(res => res.text())
      .then(data => {
        placeholder.innerHTML = data;
        if (typeof initOpenDoor === 'function') initOpenDoor();
      });
  }

  // ACTIVITY_END_TIME 時間到了以後，修改活動倒數標籤內容
  function updateEndText() {
    const now = Date.now();
    if (now >= targetTime) {
      const pTag = document.querySelector('main p');
      if (pTag) pTag.textContent = "距離開門（台灣時間 9/30 (二) 15:00）還有";
    } else {
      setTimeout(updateEndText, getCheckInterval(targetTime));
    }
  }

  updateEndText();
  handleOpenDoorHtml();
  handleOpenDoorSound();
</script>
<script src="js/open-the-door.js"></script>
</body>
</html>
